{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "ventilator-analytics",
  "title": "VentyLab Ventilator Session Analytics",
  "description": "Computed analytics report for a single ventilation session. Generated by the Analytics & Decision Support module at session end (or periodically for live dashboards). All metrics are derived from the telemetry stream — not raw samples.",
  "type": "object",
  "required": ["sessionId", "userId", "deviceId", "startTime", "endTime", "metrics", "alarmsSummary", "modeTransitions"],
  "additionalProperties": false,

  "definitions": {
    "statsBlock": {
      "type": "object",
      "description": "Reusable statistical summary for a numeric metric over the session.",
      "required": ["avg", "min", "max"],
      "additionalProperties": false,
      "properties": {
        "avg":    { "type": "number", "description": "Mean value over all valid samples." },
        "min":    { "type": "number", "description": "Minimum observed value." },
        "max":    { "type": "number", "description": "Maximum observed value." },
        "stddev": { "type": "number", "description": "Standard deviation (optional, for variability analysis).", "minimum": 0 },
        "p95":    { "type": "number", "description": "95th percentile (optional)." },
        "sampleCount": { "type": "integer", "minimum": 0, "description": "Number of telemetry samples included in this calculation." }
      }
    },
    "isoDatetime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 datetime string in UTC, e.g. '2026-02-20T14:30:00.000Z'."
    }
  },

  "properties": {
    "sessionId": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this ventilation session. Correlates to a reservation or clinical encounter."
    },

    "userId": {
      "type": "string",
      "description": "User (student/clinician) who operated the ventilator during this session.",
      "minLength": 1,
      "maxLength": 128
    },

    "deviceId": {
      "type": "string",
      "description": "Ventilator device that generated the telemetry.",
      "minLength": 1,
      "maxLength": 64
    },

    "patientProfileId": {
      "type": ["string", "null"],
      "description": "Optional reference to the simulated or real patient profile used in this session.",
      "maxLength": 128
    },

    "startTime": {
      "$ref": "#/definitions/isoDatetime",
      "description": "Session start timestamp (UTC)."
    },

    "endTime": {
      "$ref": "#/definitions/isoDatetime",
      "description": "Session end timestamp (UTC). Always > startTime."
    },

    "durationSeconds": {
      "type": "number",
      "description": "Total session duration in seconds. Convenience field: endTime − startTime.",
      "minimum": 0
    },

    "totalBreaths": {
      "type": "integer",
      "description": "Total number of breath cycles detected during the session.",
      "minimum": 0
    },

    "metrics": {
      "type": "object",
      "description": "Computed respiratory mechanics and ventilation quality indicators.",
      "required": ["dynamicCompliance", "airwayResistance", "workOfBreathing", "pressures", "volumes", "timing"],
      "additionalProperties": false,

      "properties": {
        "dynamicCompliance": {
          "allOf": [{ "$ref": "#/definitions/statsBlock" }],
          "description": "Dynamic lung compliance (Cdyn = VT / (Ppeak − PEEP)) in mL/cmH₂O. Reflects combined lung + chest wall distensibility during active flow.",
          "properties": {
            "unit": { "type": "string", "const": "mL/cmH2O" }
          }
        },

        "staticCompliance": {
          "allOf": [{ "$ref": "#/definitions/statsBlock" }],
          "description": "Static compliance (Cstat = VT / (Pplat − PEEP)) in mL/cmH₂O. Requires an inspiratory hold manoeuvre; null if no holds were performed.",
          "properties": {
            "unit": { "type": "string", "const": "mL/cmH2O" }
          }
        },

        "airwayResistance": {
          "allOf": [{ "$ref": "#/definitions/statsBlock" }],
          "description": "Airway resistance (Raw = (Ppeak − Pplat) / PeakFlow) in cmH₂O·s/L. High values indicate bronchospasm, secretions, or kinked circuit.",
          "properties": {
            "unit": { "type": "string", "const": "cmH2O·s/L" }
          }
        },

        "workOfBreathing": {
          "allOf": [{ "$ref": "#/definitions/statsBlock" }],
          "description": "Mechanical work of breathing per breath (area under pressure–volume loop) in J/L. Values > 0.8 J/L suggest increased WOB.",
          "properties": {
            "unit":  { "type": "string", "const": "J/L" },
            "totalJoules": {
              "type": "number",
              "description": "Cumulative WOB over the entire session in Joules.",
              "minimum": 0
            }
          }
        },

        "pressures": {
          "type": "object",
          "description": "Key pressure landmark statistics across all breaths.",
          "required": ["peak", "plateau", "mean", "peep"],
          "additionalProperties": false,
          "properties": {
            "peak":    { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "cmH2O" } }, "description": "Peak inspiratory pressure (Ppeak)." },
            "plateau": { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "cmH2O" } }, "description": "Plateau pressure (Pplat) from inspiratory hold manoeuvres only." },
            "mean":    { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "cmH2O" } }, "description": "Mean airway pressure (Pmean) — time-weighted average." },
            "peep":    { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "cmH2O" } }, "description": "Measured PEEP (may differ from set PEEP due to auto-PEEP)." },
            "driving": { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "cmH2O" } }, "description": "Driving pressure (ΔP = Pplat − PEEP). Target < 15 cmH₂O for lung-protective ventilation." }
          }
        },

        "volumes": {
          "type": "object",
          "description": "Tidal and minute ventilation statistics.",
          "required": ["tidalInspiratory", "tidalExpiratory", "minuteVentilation"],
          "additionalProperties": false,
          "properties": {
            "tidalInspiratory": { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "mL" } }, "description": "Delivered inspiratory tidal volume per breath." },
            "tidalExpiratory":  { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "mL" } }, "description": "Measured expiratory tidal volume per breath. VTe < VTi may indicate leak." },
            "minuteVentilation":{ "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "L/min" } }, "description": "Minute ventilation (VE = RR × VT)." },
            "leakFraction": {
              "type": "number",
              "description": "Circuit leak as a fraction: (VTi − VTe) / VTi. 0 = no leak, 1 = complete leak.",
              "minimum": 0,
              "maximum": 1
            }
          }
        },

        "timing": {
          "type": "object",
          "description": "Respiratory timing and rate statistics.",
          "required": ["respiratoryRate", "inspiratoryTime", "expiratoryTime", "ieRatio"],
          "additionalProperties": false,
          "properties": {
            "respiratoryRate":  { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "rpm" } }, "description": "Measured respiratory rate (total = mandatory + spontaneous)." },
            "inspiratoryTime":  { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "s" } }, "description": "Duration of the inspiratory phase per breath." },
            "expiratoryTime":   { "allOf": [{ "$ref": "#/definitions/statsBlock" }], "properties": { "unit": { "type": "string", "const": "s" } }, "description": "Duration of the expiratory phase per breath." },
            "ieRatio": {
              "type": "object",
              "description": "Mean I:E ratio expressed as I and E components.",
              "required": ["inspiratory", "expiratory"],
              "additionalProperties": false,
              "properties": {
                "inspiratory": { "type": "number", "description": "Inspiratory component (normalized to 1).", "const": 1 },
                "expiratory":  { "type": "number", "description": "Expiratory component (e.g. 2.1 means I:E = 1:2.1).", "minimum": 0 }
              }
            },
            "patientTriggerRate": {
              "type": "number",
              "description": "Fraction of breaths triggered by the patient (0 = fully controlled, 1 = fully spontaneous).",
              "minimum": 0,
              "maximum": 1
            },
            "autopeepDetected": {
              "type": "boolean",
              "description": "True if auto-PEEP (intrinsic PEEP) was detected at any point during the session."
            }
          }
        },

        "modeTimeDistribution": {
          "type": "array",
          "description": "Time spent in each ventilation mode during the session.",
          "items": {
            "type": "object",
            "required": ["mode", "durationSeconds", "fractionOfSession"],
            "additionalProperties": false,
            "properties": {
              "mode": {
                "type": "string",
                "enum": ["VCV", "PCV", "SIMV", "PSV", "STANDBY"]
              },
              "durationSeconds": {
                "type": "number",
                "minimum": 0
              },
              "fractionOfSession": {
                "type": "number",
                "description": "Fraction of total session duration (0–1).",
                "minimum": 0,
                "maximum": 1
              }
            }
          }
        }
      }
    },

    "alarmsSummary": {
      "type": "array",
      "description": "Aggregated alarm events fired during the session. One entry per unique alarm type.",
      "items": {
        "type": "object",
        "required": ["type", "severity", "count", "firstOccurrence"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "description": "Alarm type code matching the code field in telemetry alarm frames.",
            "examples": ["HIGH_PRESSURE", "LOW_VOLUME", "APNEA", "HIGH_RATE", "LOW_PEEP", "DISCONNECT", "HIGH_FIO2"]
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"]
          },
          "count": {
            "type": "integer",
            "description": "Total number of times this alarm fired.",
            "minimum": 1
          },
          "firstOccurrence": {
            "$ref": "#/definitions/isoDatetime",
            "description": "Timestamp of the first occurrence in this session."
          },
          "lastOccurrence": {
            "$ref": "#/definitions/isoDatetime",
            "description": "Timestamp of the most recent occurrence."
          },
          "totalDurationSeconds": {
            "type": "number",
            "description": "Cumulative time (seconds) this alarm was active.",
            "minimum": 0
          }
        }
      }
    },

    "modeTransitions": {
      "type": "array",
      "description": "Ordered log of ventilation mode changes during the session.",
      "items": {
        "type": "object",
        "required": ["from", "to", "timestamp"],
        "additionalProperties": false,
        "properties": {
          "from": {
            "type": "string",
            "enum": ["VCV", "PCV", "SIMV", "PSV", "STANDBY", "NONE"],
            "description": "'NONE' for the initial mode set at session start."
          },
          "to": {
            "type": "string",
            "enum": ["VCV", "PCV", "SIMV", "PSV", "STANDBY"]
          },
          "timestamp": {
            "$ref": "#/definitions/isoDatetime"
          },
          "triggeredBy": {
            "type": "string",
            "description": "Who or what triggered the mode change.",
            "enum": ["user", "protocol", "alarm", "system"]
          },
          "commandId": {
            "type": "string",
            "format": "uuid",
            "description": "Correlates to the Command message that caused this transition."
          }
        }
      }
    },

    "decisionSupportFlags": {
      "type": "array",
      "description": "Automated clinical decision support observations generated by the analytics engine. Not prescriptive — for educational feedback only.",
      "items": {
        "type": "object",
        "required": ["code", "severity", "message"],
        "additionalProperties": false,
        "properties": {
          "code": {
            "type": "string",
            "description": "Machine-readable flag identifier.",
            "examples": [
              "HIGH_DRIVING_PRESSURE",
              "AUTO_PEEP_RISK",
              "HIGH_WOB",
              "LOW_COMPLIANCE_TREND",
              "TIDAL_VOLUME_TOO_HIGH"
            ]
          },
          "severity": {
            "type": "string",
            "enum": ["info", "warning", "critical"]
          },
          "message": {
            "type": "string",
            "description": "Human-readable educational feedback for the student/clinician.",
            "examples": ["Mean driving pressure (18 cmH₂O) exceeds lung-protective threshold of 15 cmH₂O. Consider reducing tidal volume or PEEP."]
          },
          "relatedMetric": {
            "type": "string",
            "description": "Dot-path to the metrics field that triggered this flag.",
            "examples": ["metrics.pressures.driving.avg", "metrics.dynamicCompliance.min"]
          },
          "observedValue": {
            "type": "number",
            "description": "The metric value that triggered the flag."
          },
          "threshold": {
            "type": "number",
            "description": "The threshold that was exceeded."
          }
        }
      }
    },

    "schemaVersion": {
      "type": "string",
      "description": "Version of this analytics schema used to produce the document.",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": ["1.0.0"]
    }
  },

  "examples": [
    {
      "sessionId": "f1e2d3c4-aaaa-4bbb-8ccc-000000000001",
      "userId": "user-student-42",
      "deviceId": "VNT-SIM-001",
      "patientProfileId": "patient-ards-adult-70kg",
      "startTime": "2026-02-20T14:00:00.000Z",
      "endTime":   "2026-02-20T14:30:00.000Z",
      "durationSeconds": 1800,
      "totalBreaths": 420,
      "metrics": {
        "dynamicCompliance": { "avg": 38.2, "min": 31.0, "max": 45.1, "stddev": 3.4, "sampleCount": 420, "unit": "mL/cmH2O" },
        "staticCompliance":  { "avg": 42.0, "min": 38.5, "max": 46.0, "sampleCount": 12, "unit": "mL/cmH2O" },
        "airwayResistance":  { "avg": 8.5,  "min": 6.2,  "max": 12.1, "unit": "cmH2O·s/L" },
        "workOfBreathing":   { "avg": 0.62, "min": 0.48, "max": 0.91, "totalJoules": 260.4, "unit": "J/L" },
        "pressures": {
          "peak":    { "avg": 24.1, "min": 20.0, "max": 28.5, "unit": "cmH2O" },
          "plateau": { "avg": 20.5, "min": 18.0, "max": 23.0, "sampleCount": 12, "unit": "cmH2O" },
          "mean":    { "avg": 12.3, "min": 10.0, "max": 14.5, "unit": "cmH2O" },
          "peep":    { "avg": 5.1,  "min": 5.0,  "max": 5.3,  "unit": "cmH2O" },
          "driving": { "avg": 15.4, "min": 13.0, "max": 18.0, "unit": "cmH2O" }
        },
        "volumes": {
          "tidalInspiratory":  { "avg": 498.0, "min": 490.0, "max": 506.0, "unit": "mL" },
          "tidalExpiratory":   { "avg": 492.0, "min": 480.0, "max": 504.0, "unit": "mL" },
          "minuteVentilation": { "avg": 7.0,   "min": 6.8,   "max": 7.2,   "unit": "L/min" },
          "leakFraction": 0.012
        },
        "timing": {
          "respiratoryRate": { "avg": 14.1, "min": 14.0, "max": 15.0, "unit": "rpm" },
          "inspiratoryTime": { "avg": 1.01, "min": 0.98, "max": 1.05, "unit": "s" },
          "expiratoryTime":  { "avg": 3.27, "min": 3.10, "max": 3.45, "unit": "s" },
          "ieRatio": { "inspiratory": 1, "expiratory": 3.24 },
          "patientTriggerRate": 0.0,
          "autopeepDetected": false
        },
        "modeTimeDistribution": [
          { "mode": "VCV", "durationSeconds": 1800, "fractionOfSession": 1.0 }
        ]
      },
      "alarmsSummary": [
        {
          "type": "HIGH_PRESSURE",
          "severity": "high",
          "count": 3,
          "firstOccurrence": "2026-02-20T14:08:12.000Z",
          "lastOccurrence":  "2026-02-20T14:22:45.000Z",
          "totalDurationSeconds": 12.5
        }
      ],
      "modeTransitions": [
        {
          "from": "NONE",
          "to": "VCV",
          "timestamp": "2026-02-20T14:00:00.000Z",
          "triggeredBy": "user",
          "commandId": "b4e2a1c0-ffff-4abc-8000-000000000042"
        }
      ],
      "decisionSupportFlags": [
        {
          "code": "HIGH_DRIVING_PRESSURE",
          "severity": "warning",
          "message": "Mean driving pressure (15.4 cmH₂O) is at the upper limit for lung-protective ventilation. Consider reducing tidal volume by 20–30 mL.",
          "relatedMetric": "metrics.pressures.driving.avg",
          "observedValue": 15.4,
          "threshold": 15.0
        }
      ],
      "schemaVersion": "1.0.0"
    }
  ]
}
